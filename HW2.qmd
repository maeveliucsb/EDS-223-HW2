---
title: "HW2"
format: html
editor: visual
---

## Preamble

```{r}
#Library Loading
library(sf)
library(here)
library(tidyverse)
library(tmap)
library(viridis)

#data loading
ejscreen <- st_read(here("data", "ejscreen", "EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb"))
HOLC <- st_read(here("data", "mapping-inequality", "mapping-inequality-los-angeles.json"))
BDobs <- st_read(here("data", "gbif-birds-LA", "gbif-birds-LA.shp"))
```

# Part 1: Legacy of redlining in current environmental (in)justice

#### Create a map of historical redlining neighborhoods

-   neighborhoods colored by HOLC grade
-   an appropriate base map
-   a clear title and legend

```{r}
tm_shape(HOLC) +
  tm_polygons(
    fill = "grade",
    fill.legend = tm_legend(title = "Grade of neighborhoods in LA")
  ) +
    tm_borders(col = "black") +
  tm_title_out("Redlining in Los Angeles")
```

#### Create a table summarizing

-   The percentage of census block groups that fall within each HOLC grade
-   Also include the percent of census block groups that donâ€™t fall within a HOLC grade

```{r}
percenttable <- HOLC |>
  st_drop_geometry() |>
  dplyr::count(grade, name = "n_blocks") |>
  dplyr::mutate(pct_blocks = 100 * n_blocks / sum(n_blocks))
view(percenttable)
```

#### Create at least two visualizations summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables (you may combine variables or create separate plots):

-   % low income
-   Percentile for Particulate Matter 2.5
-   percentile for low life expectancy
-   Use ggplot for your visualizations! You will first need to calculate mean of each variable grouped by HOLC grade.

####Plot 1

```{r}
EJLA <- ejscreen %>% filter(CNTY_NAME == 'Los Angeles County') #filtering for just Los Angeles
st_crs(EJLA) == st_crs(HOLC) #checking if the crs matches
EJLA <- st_transform(EJLA, crs = st_crs(HOLC)) #transforming CRS
HOLC <- st_make_valid(HOLC) #running this, because when I tried to marry the datasets, (st_join) I was getting errors, this should eliminate extras

EJLA_HOLC <- st_join(EJLA, HOLC, join = st_intersects) #marrying the datasets
names(EJLA_HOLC)
#computing the mean by grade
means_by_grade <- EJLA_HOLC %>%
  sf::st_drop_geometry() %>%
  dplyr::group_by(grade) %>%
  dplyr::summarise(
    mean_low_income_pct    = mean(LOWINCPCT, na.rm = TRUE),
    mean_pm25_percentile   = mean(P_PM25,    na.rm = TRUE), 
    mean_life_expectancy   = mean(LIFEEXPPCT, na.rm = TRUE)
  )

#Visualization code
ggplot(means_by_grade, aes(x = grade, y = mean_low_income_pct)) +
  geom_col() +
  labs(
    title = "% Low Income by Grade (LA County)",
    x = "Grade",
    y = "Mean % Low Income (block-group mean within grade)"
  ) +
  theme_minimal(base_size = 12)
```
####Plot 2
```{r}
#Visualization code
ggplot(means_by_grade, aes(x = grade, y = mean_pm25_percentile)) +
  geom_col() +
  labs(
    title = "Percentile of 2.5 Particulate Matter by Grade (LA County)",
    x = "Grade",
    y = "2.5 Particulate Matter 2.5 Percentile (block-group mean within grade)", 
  ) +
  theme_minimal(base_size = 12)
```
```{r}
ggplot(means_by_grade, aes(x = grade, y = mean_life_expectancy)) +
  geom_col() +
  labs(
    title = "Life expectancy by Grade (LA County)",
    x = "Grade",
    y = "Mean Life Expectancy (block-group mean within grade)"
  ) +
  theme_minimal(base_size = 12)
```
#### Write a brief paragraph reflecting on these results

# Part 2: Legacy of redlining in current environmental (in)justice